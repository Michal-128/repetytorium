import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.awt.image.BufferedImage;
import java.io.*;
import javax.imageio.ImageIO;
import java.util.*;
import java.util.function.Supplier;

public class RysPanel extends JPanel {
    private BufferedImage canvas;
    private Graphics2D g2d;

    private int startX, startY;
    private boolean dragging = false;

    private java.util.List<Point> polygonPoints = new ArrayList<>();
    private boolean drawingPolygon = false;

    private Supplier<String> shapeProvider;
    private Supplier<Color> colorProvider;

    public RysPanel() {
        setPreferredSize(new Dimension(800, 600));
        canvas = new BufferedImage(800, 600, BufferedImage.TYPE_INT_ARGB);
        g2d = canvas.createGraphics();
        g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        clearCanvas();

        addMouseListener(new MouseAdapter() {
            @Override
            public void mousePressed(MouseEvent e) {
                String shape = shapeProvider.get();
                if ("Wielokąt".equals(shape)) {
                    polygonPoints.add(new Point(e.getX(), e.getY()));
                    drawingPolygon = true;
                    repaint();
                } else {
                    startX = e.getX();
                    startY = e.getY();
                    dragging = true;
                }
            }

            @Override
            public void mouseReleased(MouseEvent e) {
                String shape = shapeProvider.get();
                if ("Wielokąt".equals(shape)) {
                    if (SwingUtilities.isRightMouseButton(e) && drawingPolygon && polygonPoints.size() >= 3) {
                        commitPolygon();
                        drawingPolygon = false;
                        polygonPoints.clear();
                        repaint();
                    }
                } else {
                    if (dragging) {
                        if (!"Pędzel".equals(shape)) {
                            int x2 = e.getX();
                            int y2 = e.getY();
                            commitShape(startX, startY, x2, y2);
                        }
                        dragging = false;
                        repaint();
                    }
                }
            }
        });

        addMouseMotionListener(new MouseAdapter() {
            @Override
            public void mouseDragged(MouseEvent e) {
                String shape = shapeProvider.get();
                if (!"Wielokąt".equals(shape) && dragging) {
                    if ("Pędzel".equals(shape)) {
                        g2d.setColor(colorProvider.get());
                        g2d.drawLine(startX, startY, e.getX(), e.getY());
                        startX = e.getX();
                        startY = e.getY();
                        repaint();
                    } else {
                        repaint();
                        Graphics g = getGraphics();
                        drawShapeOnGraphics(g, startX, startY, e.getX(), e.getY());
                        g.dispose();
                    }
                }
            }

            @Override
            public void mouseMoved(MouseEvent e) {
                if (drawingPolygon) {
                    repaint();
                    Graphics g = getGraphics();
                    drawPolygonPreview(g, e.getX(), e.getY());
                    g.dispose();
                }
            }
        });

        addComponentListener(new ComponentAdapter() {
            @Override
            public void componentResized(ComponentEvent e) {
                int width = getWidth();
                int height = getHeight();
                if (canvas == null || width > canvas.getWidth() || height > canvas.getHeight()) {
                    BufferedImage newCanvas = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
                    Graphics2D gNew = newCanvas.createGraphics();
                    gNew.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    gNew.setColor(Color.WHITE);
                    gNew.fillRect(0, 0, width, height);
                    if (canvas != null) {
                        gNew.drawImage(canvas, 0, 0, null);
                    }
                    gNew.dispose();
                    canvas = newCanvas;
                    g2d = canvas.createGraphics();
                    g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    repaint();
                }
            }
        });
    }

    public void setShapeProvider(Supplier<String> sp) {
        this.shapeProvider = sp;
    }

    public void setColorProvider(Supplier<Color> cp) {
        this.colorProvider = cp;
    }

    private void commitShape(int x1, int y1, int x2, int y2) {
        g2d.setColor(colorProvider.get());
        drawShapeOnGraphics(g2d, x1, y1, x2, y2);
    }

    private void commitPolygon() {
        g2d.setColor(colorProvider.get());
        int n = polygonPoints.size();
        int[] xs = new int[n];
        int[] ys = new int[n];
        for (int i = 0; i < n; i++) {
            xs[i] = polygonPoints.get(i).x;
            ys[i] = polygonPoints.get(i).y;
        }
        g2d.drawPolygon(xs, ys, n);
    }

    private void drawShapeOnGraphics(Graphics g, int x1, int y1, int x2, int y2) {
        String shape = shapeProvider.get();
        g.setColor(colorProvider.get());
        int x = Math.min(x1, x2);
        int y = Math.min(y1, y2);
        int width = Math.abs(x2 - x1);
        int height = Math.abs(y2 - y1);

        switch (shape) {
            case "Prostokąt":
                g.drawRect(x, y, width, height);
                break;
            case "Okrąg":
                g.drawOval(x, y, width, height);
                break;
            case "Linia":
                g.drawLine(x1, y1, x2, y2);
                break;
        }
    }

    private void drawPolygonPreview(Graphics g, int cursorX, int cursorY) {
        if (polygonPoints.isEmpty()) return;
        g.setColor(colorProvider.get());
        Point prev = polygonPoints.get(0);
        for (int i = 1; i < polygonPoints.size(); i++) {
            Point p = polygonPoints.get(i);
            g.drawLine(prev.x, prev.y, p.x, p.y);
            prev = p;
        }
        if (cursorX >= 0 && cursorY >= 0) {
            Point last = polygonPoints.get(polygonPoints.size() - 1);
            g.drawLine(last.x, last.y, cursorX, cursorY);
        }
    }

    public void clearCanvas() {
        g2d.setColor(Color.WHITE);
        g2d.fillRect(0, 0, canvas.getWidth(), canvas.getHeight());
        repaint();
    }

    public void saveImage() {
        JFileChooser chooser = new JFileChooser();
        chooser.setDialogTitle("Zapisz obraz jako...");
        chooser.setSelectedFile(new File("rysunek.png"));

        int res = chooser.showSaveDialog(this);
        if (res == JFileChooser.APPROVE_OPTION) {
            File file = chooser.getSelectedFile();
            if (!file.getName().toLowerCase().endsWith(".png")) {
                file = new File(file.getAbsolutePath() + ".png");
            }
            try {
                ImageIO.write(canvas, "PNG", file);
                JOptionPane.showMessageDialog(this, "Obraz zapisano jako: " + file.getName());
            } catch (IOException e) {
                JOptionPane.showMessageDialog(this, "Błąd zapisu pliku: " + e.getMessage());
            }
        }
    }

    public void loadImage() {
        JFileChooser chooser = new JFileChooser();
        int res = chooser.showOpenDialog(this);
        if (res == JFileChooser.APPROVE_OPTION) {
            try {
                BufferedImage img = ImageIO.read(chooser.getSelectedFile());
                canvas = new BufferedImage(img.getWidth(), img.getHeight(), BufferedImage.TYPE_INT_ARGB);
                g2d = canvas.createGraphics();
                g2d.drawImage(img, 0, 0, null);
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                repaint();
            } catch (IOException e) {
                JOptionPane.showMessageDialog(this, "Błąd wczytywania.");
            }
        }
    }

    @Override
    protected void paintComponent(Graphics g) {
        super.paintComponent(g);
        g.drawImage(canvas, 0, 0, null);
        if (drawingPolygon && !polygonPoints.isEmpty()) {
            drawPolygonPreview(g, -1, -1);
        }
    }
}
